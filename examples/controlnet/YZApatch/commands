cd /cpfs01/projects-SSD/cfff-27504eab520e_SSD/zwz_42312/yza/diffusers
pip install -e .

screen -S controlnet
screen -r controlnet

cd /cpfs01/projects-SSD/cfff-27504eab520e_SSD/zwz_42312/yza/diffusers
conda activate jointdit121

export HF_ENDPOINT=https://hf-mirror.com
export HUGGINGFACE_HUB_ENDPOINT=https://hf-mirror.com

ln -s /cpfs01/projects-SSD/cfff-27504eab520e_SSD/zwz_42312/yza/Edge-JointDiT/dataset/coco2017/DexiNed-master \
      /cpfs01/projects-SSD/cfff-27504eab520e_SSD/zwz_42312/yza/Edge-JointDiT/DexiNed


正常训练：
accelerate launch --config_file /cpfs01/projects-SSD/cfff-27504eab520e_SSD/zwz_42312/yza/Edge-JointDiT/my_config.yaml /cpfs01/projects-SSD/cfff-27504eab520e_SSD/zwz_42312/yza/diffusers/examples/controlnet/train_controlnet_sdxl.py \
  --pretrained_model_name_or_path="diffusers/stable-diffusion-xl-1.0-inpainting-0.1" \
  --controlnet_model_name_or_path="xinsir/controlnet-scribble-sdxl-1.0" \
  --use_custom_dataset \
  --enable_edge_cache \
  --resolution=512 \
  --learning_rate=2e-5 \
  --lr_scheduler="cosine_with_restarts" \
  --lr_num_cycles=5 \
  --lr_warmup_steps=500 \
  --train_batch_size=12 \
  --gradient_accumulation_steps=4 \
  --max_train_steps=30000 \
  --checkpointing_steps=5000 \
  --output_dir="/cpfs01/projects-SSD/cfff-27504eab520e_SSD/zwz_42312/yza/diffusers/examples/controlnet/output/2" \
  --proportion_empty_prompts=1.0 \
  --mixed_precision="fp16" \
  --enable_xformers_memory_efficient_attention \
  --dataloader_num_workers=4 \
  --report_to="tensorboard" \
  --parallel_preload \
  2>&1 | tee -a "/cpfs01/projects-SSD/cfff-27504eab520e_SSD/zwz_42312/yza/diffusers/examples/controlnet/output/redirect/train_$(date +%Y%m%d_%H%M%S).log"

tensorboard --logdir "/cpfs01/projects-SSD/cfff-27504eab520e_SSD/zwz_42312/yza/diffusers/examples/controlnet/output/1/logs/sd_xl_train_controlnet"

grep -n "Traceback" train_20260210_153012.log

准备mask和sketch
python /cpfs01/projects-SSD/cfff-27504eab520e_SSD/zwz_42312/yza/diffusers/examples/controlnet/YZAtool/generate_test_edges.py \
  --input_dir "/cpfs01/projects-SSD/cfff-27504eab520e_SSD/zwz_42312/yza/data/artbench/export_512/test" \
  --resolution 512

推理：
python YZAtool/inference_inpaint_sdxl_controlnet.py \
  --input_dir "/path/to/your/test" \
  --output_dir "/path/to/your/test_inpaint" \
  --pretrained_model_name_or_path "diffusers/stable-diffusion-xl-1.0-inpainting-0.1" \
  --controlnet_model_name_or_path "/path/to/your/trained/controlnet" \
  --resolution 512 \
  --batch_size 4 \
  --num_inference_steps 20 \
  --guidance_scale 5.0 \
  --device cuda \
  --prompt "" \
  --strict_mode

# accelerate launch --config_file /cpfs01/projects-SSD/cfff-27504eab520e_SSD/zwz_42312/yza/Edge-JointDiT/my_config.yaml /cpfs01/projects-SSD/cfff-27504eab520e_SSD/zwz_42312/yza/diffusers/examples/controlnet/train_controlnet_sdxl.py \
#   --pretrained_model_name_or_path="diffusers/stable-diffusion-xl-1.0-inpainting-0.1" \
#   --controlnet_model_name_or_path="xinsir/controlnet-scribble-sdxl-1.0" \
#   --use_custom_dataset \
#   --enable_edge_cache \
#   --resolution=512 \
#   --learning_rate=1e-5 \
#   --train_batch_size=16 \
#   --gradient_accumulation_steps=4 \
#   --max_train_steps=60000 \
#   --checkpointing_steps=10000 \
#   --output_dir="/cpfs01/projects-SSD/cfff-27504eab520e_SSD/zwz_42312/yza/diffusers/examples/controlnet/output/1" \
#   --proportion_empty_prompts=1.0 \
#   --mixed_precision="fp16" \
#   --enable_xformers_memory_efficient_attention \
#   --dataloader_num_workers=4 \
#   --report_to="tensorboard" \
#   --max_train_samples 100